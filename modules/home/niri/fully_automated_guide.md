# Fully Automated Niri + DMS + danksearch Setup Guide

## Overview

This guide sets up **fully automated** theming between DankMaterialShell and Niri, where wallpaper changes automatically update Niri colors via home-manager rebuilds.

## Prerequisites

- NixOS or Home Manager with flakes enabled
- Git installed
- Basic understanding of Nix flakes
- A git repository for your home-manager configuration

## Architecture

```
Wallpaper Change (DMS)
    ‚Üì
DMS runs matugen
    ‚Üì
Colors saved to ~/.config/DankMaterialShell/dms-colors.json
    ‚Üì
Systemd path watcher detects file change
    ‚Üì
auto-rebuild-niri-theme.service triggers
    ‚Üì
home-manager reads colors via builtins.fromJSON in niri.nix
    ‚Üì
home-manager switch rebuilds configuration
    ‚Üì
Niri detects config.kdl change and auto-reloads
    ‚Üì
‚úÖ Colors updated automatically!
```

## How It Works

**Key Innovation:** The `niri.nix` file uses Nix's `builtins.fromJSON` and `builtins.readFile` to dynamically read DMS colors during home-manager evaluation. When combined with a systemd watcher that triggers rebuilds on color changes, this creates a fully automated theming system.

## Step 1: Update flake.nix

Create or update your `~/.config/home-manager/flake.nix`:

```nix
{
  description = "NixOS configuration with DMS and Niri";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";

    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    niri = {
      url = "github:sodiboo/niri-flake";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    dsearch = {
      url = "github:AvengeMedia/danksearch";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    dankMaterialShell = {
      url = "github:AvengeMedia/DankMaterialShell";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    quickshell = {
      url = "git+https://git.outfoxxed.me/outfoxxed/quickshell";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, home-manager, niri, ... }@inputs: {
    homeConfigurations."your-username" = home-manager.lib.homeManagerConfiguration {
      pkgs = import nixpkgs {
        system = "x86_64-linux";  # or "aarch64-linux" for ARM
        config.allowUnfree = true;
      };

      extraSpecialArgs = { inherit inputs; };

      modules = [
        niri.homeModules.niri
        ./niri.nix
        ./dms.nix
        ./danksearch.nix
        # Add other modules here
      ];
    };
  };
}
```

**Important:** Replace `"your-username"` with your actual username.

## Step 2: File Structure

Your home-manager directory should look like this:

```
~/.config/home-manager/
‚îú‚îÄ‚îÄ flake.nix          # Your flake configuration
‚îú‚îÄ‚îÄ flake.lock         # Generated by Nix
‚îú‚îÄ‚îÄ niri.nix           # Niri configuration (from corrected artifact)
‚îú‚îÄ‚îÄ dms.nix            # DMS with auto-rebuild (from corrected artifact)
‚îî‚îÄ‚îÄ danksearch.nix     # danksearch configuration (from corrected artifact)
```

**Note:** All scripts are embedded in the `.nix` files and generated automatically by Nix. You don't need to create any separate script files.

## Step 3: Customize Configuration Files

Before building, adjust these settings for your system:

### In `niri.nix`:

```nix
# Update for your monitors
outputs = {
  "HDMI-A-1" = {  # Change to your output name
    mode = {
      width = 2560;   # Your resolution
      height = 1440;
      refresh = 60.0;
    };
    scale = 2.0;      # Adjust scaling
  };
  "eDP-1".enable = false;  # Disable laptop screen if needed
};
```

### In `danksearch.nix`:

```nix
# Adjust for your CPU
indexing = {
  workers = 8;  # Set to your CPU core count
  # ...
};

# Customize paths to index
paths = [
  config.home.homeDirectory  # Your home directory
  # Add more paths if needed:
  # "/media/data"
];
```

## Step 4: Initial Setup

```bash
# 1. Navigate to your home-manager directory
cd ~/.config/home-manager

# 2. Initialize git if not already done
git init

# 3. Add all files
git add .

# 4. Make initial commit (required for flakes)
git commit -m "Initial fully automated setup"

# 5. Build and activate
home-manager switch --flake .#your-username
```

**Troubleshooting first build:**

- If you get "file not tracked by git" errors: `git add .` and try again
- If you get package not found errors: Check your flake.nix inputs
- If build fails: Run with `--show-trace` for detailed errors

## Step 5: Start Services

After successful build:

```bash
# Start DMS
systemctl --user start dankMaterialShell

# Start danksearch (should auto-start, but verify)
systemctl --user status dsearch

# Verify all services are running
systemctl --user is-active dankMaterialShell  # Should show: active
systemctl --user is-active dsearch             # Should show: active
systemctl --user is-active watch-dms-colors.path  # Should show: active
```

## Step 6: Generate Initial Colors

```bash
# Set your first wallpaper (this generates colors)
qs -c DankMaterialShell ipc call wallpaper set ~/Pictures/your-wallpaper.jpg
```

Wait a few seconds for DMS to generate colors. Check that the color file was created:

```bash
# Should show JSON color data
cat ~/.config/DankMaterialShell/dms-colors.json
```

## Step 7: Verify Automation

Test that the full automation chain works:

```bash
# Terminal 1: Watch the auto-rebuild logs
journalctl --user -u auto-rebuild-niri-theme -f
```

```bash
# Terminal 2: Change wallpaper
qs -c DankMaterialShell ipc call wallpaper set ~/Pictures/another-wallpaper.jpg
```

**What should happen:**

1. DMS changes wallpaper (immediate)
2. Matugen generates new colors (~2-5 seconds)
3. Colors saved to dms-colors.json
4. Systemd watcher detects change (immediate)
5. auto-rebuild-niri-theme service starts
6. home-manager rebuilds config (5-30 seconds)
7. Niri detects config change and reloads (immediate)
8. New colors visible in focus rings, tabs, etc.

**You should see logs like:**

```
[auto-rebuild-niri-theme] DMS colors changed, triggering home-manager rebuild...
[auto-rebuild-niri-theme] Backed up niri config to ...
[auto-rebuild-niri-theme] Running home-manager switch...
[auto-rebuild-niri-theme] ‚úì Home-manager rebuild successful
[auto-rebuild-niri-theme] ‚úì Niri will automatically reload with new colors
[auto-rebuild-niri-theme] New colors applied:
[auto-rebuild-niri-theme]   Primary: #...
```

## Commands Reference

All these commands are automatically created by the Nix configuration:

### DMS Control

```bash
# Change wallpaper (triggers auto-theming)
qs -c DankMaterialShell ipc call wallpaper set /path/to/image.jpg

# Toggle dark/light theme
qs -c DankMaterialShell ipc call theme toggle

# Open launcher
qs -c DankMaterialShell ipc call spotlight toggle

# Volume control
qs -c DankMaterialShell ipc call audio setvolume 50
qs -c DankMaterialShell ipc call audio mute
qs -c DankMaterialShell ipc call audio unmute
```

### Color Management (Created by dms.nix)

```bash
# View current DMS colors (JSON format)
dms-show-colors

# View current Niri colors (formatted)
niri-show-colors

# Manually trigger a rebuild
dms-trigger-rebuild

# Check auto-rebuild system status
dms-rebuild-status

# Disable auto-rebuild temporarily
dms-disable-auto-rebuild

# Re-enable auto-rebuild
dms-enable-auto-rebuild
```

### danksearch (Created by danksearch.nix)

```bash
# Search for files
dsearch search "query"

# Search with wildcards
dsearch search "*.nix" --limit 0

# Fuzzy search (typo-tolerant)
dsearch search "confg" --fuzzy

# Search file contents (not just names)
dsearch search "function" --field body

# Search in specific directory
dsearch search "*" --folder ~/Documents

# Quick search from terminal (helper script)
dsearch-query "term"

# Get JSON output
dsearch-query "term" --json

# Check service status
dsearch-status

# Test API functionality
dsearch-test

# Force complete reindex
dsearch-reindex

# View current configuration
dsearch-config-show
```

### Niri Commands

```bash
# Validate config (useful after manual edits)
niri validate

# Get window info
niri msg --json windows

# Get workspace info
niri msg --json workspaces

# Take screenshot
niri msg action screenshot
```

## Troubleshooting

### Colors Not Updating Automatically

```bash
# 1. Check DMS is running
systemctl --user status dankMaterialShell

# 2. Check DMS colors file exists and is valid
cat ~/.config/DankMaterialShell/dms-colors.json | jq

# 3. Check path watcher is active
systemctl --user status watch-dms-colors.path

# 4. Check auto-rebuild service
systemctl --user status auto-rebuild-niri-theme

# 5. View recent logs
journalctl --user -u auto-rebuild-niri-theme -n 50

# 6. Try manual rebuild
dms-trigger-rebuild
```

### Home-Manager Rebuild Fails

```bash
# Check for Nix syntax errors
cd ~/.config/home-manager
nix flake check

# Try build with detailed trace
home-manager switch --flake .#your-username --show-trace

# Validate niri config
niri validate

# Check if files are git-tracked
git status
git add .  # Add any untracked files
```

### DMS Not Generating Colors

```bash
# Check if matugen is available
which matugen

# Check DMS logs
journalctl --user -u dankMaterialShell -n 50

# Check if matugen is disabled
echo $DMS_DISABLE_MATUGEN  # Should be empty

# Try setting wallpaper again
qs -c DankMaterialShell ipc call wallpaper set ~/wallpaper.jpg

# Wait and check colors file
sleep 5
cat ~/.config/DankMaterialShell/dms-colors.json
```

### danksearch Not Indexing

```bash
# Check service status
systemctl --user status dsearch

# View detailed logs
journalctl --user -u dsearch -f

# Check if index directory exists
ls -la ~/.local/share/dsearch/index/

# Test API connectivity
curl http://localhost:43654/health

# Force reindex
dsearch-reindex
```

### First Build Issues

**Problem:** "error: cannot look up <nixpkgs> in pure evaluation mode"
**Solution:** Make sure you're using `--flake` flag: `home-manager switch --flake .#your-username`

**Problem:** "error: getting status of '/nix/store/...-source/.git': No such file or directory"
**Solution:** Run `git init && git add .` in your home-manager directory

**Problem:** Package not found (dsearch, dankMaterialShell, etc.)
**Solution:** Verify flake.nix inputs are correct and run `nix flake lock`

## Performance Tuning

### Rebuild Frequency

Each wallpaper change triggers a full home-manager rebuild. If this is too frequent:

**Option 1: Disable temporarily**

```bash
# Disable auto-rebuild
dms-disable-auto-rebuild

# Change wallpapers as much as you want
qs -c DankMaterialShell ipc call wallpaper set ~/wallpaper1.jpg
qs -c DankMaterialShell ipc call wallpaper set ~/wallpaper2.jpg
qs -c DankMaterialShell ipc call wallpaper set ~/wallpaper3.jpg

# When done, rebuild once
dms-trigger-rebuild

# Re-enable auto-rebuild
dms-enable-auto-rebuild
```

**Option 2: Add battery check**
If on a laptop, you can modify the auto-rebuild to only work on AC power. Add this check to the `autoRebuildScript` in `dms.nix`:

```nix
# Check if on battery (optional)
if ! ${pkgs.acpi}/bin/on_ac_power 2>/dev/null; then
  log "On battery, skipping rebuild"
  exit 0
fi
```

### danksearch Performance

```nix
# In danksearch.nix, adjust these for your needs:
indexing = {
  workers = 16;  # More workers = faster indexing (use CPU core count)
  extract_content = false;  # Disable for metadata-only search (faster)
  max_content_size = 1048576;  # 1MB = faster indexing, less content search
};
```

### Build Speed

```bash
# Use nom for better build visualization
nix shell nixpkgs#nix-output-monitor
nom build .#homeConfigurations.your-username.activationPackage

# Or use as alias
alias hm-build="nom home-manager"
hm-build switch --flake .#your-username
```

## Customization

### Change Color Mapping

Edit the `colorConfig` in `niri.nix` to use different DMS colors:

```nix
colorConfig = {
  # Use primary container instead of primary
  primary = dmsColors.primaryContainer or defaultColors.primary;

  # Use on-surface instead of surface variant text
  inactive = dmsColors.onSurface or defaultColors.surfaceVariantText;

  # Use warning instead of error
  urgent = dmsColors.warning or defaultColors.error;

  # ... etc
};
```

### Add More Indexed Paths

Edit `danksearch.nix`:

```nix
paths = [
  config.home.homeDirectory
  "/media/external-drive"
  "/mnt/nas-storage"
];
```

### Change Default Colors

Edit the `defaultColors` in `niri.nix` (used before first wallpaper set):

```nix
defaultColors = {
  primary = "#your-color";
  surfaceVariantText = "#your-color";
  error = "#your-color";
  shadow = "#000000";
};
```

## Advanced Usage

### Manual Color Override

If you want to temporarily use specific colors without changing wallpaper:

```bash
# 1. Disable auto-rebuild
dms-disable-auto-rebuild

# 2. Edit DMS colors manually
nano ~/.config/DankMaterialShell/dms-colors.json

# 3. Trigger rebuild
dms-trigger-rebuild

# 4. Re-enable when done
dms-enable-auto-rebuild
```

### Backup Management

Auto-rebuild creates backups in `~/.config/niri/backups/`:

```bash
# List backups
ls -lht ~/.config/niri/backups/

# Restore a backup (replace config.kdl with backup)
cp ~/.config/niri/backups/config.kdl.backup-20241106-123456 ~/.config/niri/config.kdl
# Note: This will be overwritten on next rebuild
```

### Integration with Other Tools

The DMS colors are available in standard JSON format, so you can integrate with other tools:

```bash
# Read colors in your own scripts
PRIMARY=$(jq -r '.primary' ~/.config/DankMaterialShell/dms-colors.json)

# Use in other apps
# Many apps can read JSON and apply colors dynamically
```

## File Locations Reference

After setup, these files and directories exist:

```
# Configuration (declarative - in your repo)
~/.config/home-manager/
‚îú‚îÄ‚îÄ flake.nix
‚îú‚îÄ‚îÄ niri.nix
‚îú‚îÄ‚îÄ dms.nix
‚îî‚îÄ‚îÄ danksearch.nix

# Generated by DMS
~/.config/DankMaterialShell/
‚îî‚îÄ‚îÄ dms-colors.json          # Source of truth for colors

# Generated by home-manager
~/.config/niri/
‚îú‚îÄ‚îÄ config.kdl               # Generated from niri.nix
‚îú‚îÄ‚îÄ backups/                 # Auto-created backups
‚îÇ   ‚îî‚îÄ‚îÄ config.kdl.backup-*
‚îî‚îÄ‚îÄ AUTO_REBUILD_INFO.md     # Guide created by dms.nix

# Generated by danksearch
~/.config/dsearch/
‚îî‚îÄ‚îÄ config.toml              # Generated from danksearch.nix

~/.local/share/dsearch/
‚îú‚îÄ‚îÄ index/                   # Search index data
‚îî‚îÄ‚îÄ README.md                # Guide created by danksearch.nix

# DMS themes (auto-generated)
~/.config/gtk-3.0/
‚îî‚îÄ‚îÄ dank-colors.css

~/.config/gtk-4.0/
‚îî‚îÄ‚îÄ dank-colors.css
```

## What Gets Automatically Created

The Nix configuration automatically creates these helper commands:

**From dms.nix:**

- `dms-show-colors` - View current DMS colors
- `dms-trigger-rebuild` - Manually trigger rebuild
- `dms-disable-auto-rebuild` - Disable automation
- `dms-enable-auto-rebuild` - Enable automation
- `dms-rebuild-status` - Check system status

**From niri.nix:**

- `niri-show-colors` - View current Niri colors

**From danksearch.nix:**

- `dsearch-status` - Check indexing status
- `dsearch-reindex` - Force reindex
- `dsearch-test` - Test API
- `dsearch-query` - Quick search
- `dsearch-config-show` - View config

## Maintenance

### Update Flake Inputs

```bash
cd ~/.config/home-manager

# Update all inputs
nix flake update

# Update specific input
nix flake lock --update-input dankMaterialShell

# Rebuild with updates
home-manager switch --flake .#your-username
```

### Clean Old Generations

```bash
# List generations
home-manager generations

# Remove old generations
home-manager expire-generations "-7 days"

# Clean up nix store
nix-collect-garbage -d

# Deep clean (removes all old generations)
home-manager expire-generations "-0 days"
nix-collect-garbage -d
```

### Commit Changes

```bash
cd ~/.config/home-manager

# Add any changes
git add .

# Commit
git commit -m "Update configuration"

# Push to remote (if using remote repo)
git push
```

## Benefits Summary

‚úÖ **Zero manual intervention** - Wallpaper changes automatically update all colors
‚úÖ **Consistent theming** - GTK, Qt, terminals, and Niri all match
‚úÖ **Fast indexed search** - Find files instantly with danksearch
‚úÖ **Declarative config** - Everything in git, reproducible on any machine
‚úÖ **Safe updates** - Automatic backups before each rebuild
‚úÖ **Easy rollback** - `home-manager switch --rollback` if issues occur
‚úÖ **No permanent edits** - Config managed by home-manager, no manual file editing
‚úÖ **Helper commands** - Easy control and troubleshooting

## Limitations

‚ö†Ô∏è **Rebuild time**: 5-30 seconds per wallpaper change (depends on hardware)
‚ö†Ô∏è **Impure evaluation**: Uses `builtins.readFile` which reads from filesystem
‚ö†Ô∏è **Git required**: Flakes need files to be git-tracked
‚ö†Ô∏è **Network on cache miss**: Rebuilds may download packages if not cached

## Tips for Daily Use

### Quick wallpaper changes

```bash
# Disable auto-rebuild
dms-disable-auto-rebuild

# Change wallpapers quickly
qs -c DankMaterialShell ipc call wallpaper set ~/pic1.jpg
qs -c DankMaterialShell ipc call wallpaper set ~/pic2.jpg
qs -c DankMaterialShell ipc call wallpaper set ~/pic3.jpg

# Rebuild once when happy
dms-trigger-rebuild
```

### Check what changed

```bash
# Before wallpaper change
niri-show-colors

# After wallpaper change (wait for rebuild)
niri-show-colors

# Compare
```

### Monitor the system

```bash
# Watch all relevant logs
journalctl --user -u dankMaterialShell -u dsearch -u auto-rebuild-niri-theme -f
```

## Resources

- **Niri Wiki**: https://github.com/YaLTeR/niri/wiki
- **Niri IPC Docs**: https://github.com/YaLTeR/niri/wiki/IPC
- **niri-flake**: https://github.com/sodiboo/niri-flake
- **DMS GitHub**: https://github.com/AvengeMedia/DankMaterialShell
- **DMS Custom Themes**: https://github.com/AvengeMedia/DankMaterialShell/blob/master/docs/CUSTOM_THEMES.md
- **danksearch**: https://github.com/AvengeMedia/danksearch
- **Quickshell**: https://git.outfoxxed.me/outfoxxed/quickshell
- **Home Manager**: https://nix-community.github.io/home-manager/

---

**You now have a fully automated, dynamically themed desktop! Enjoy! üé®‚ú®**
